config {
    tags: ["cubo-vendas", "venda_dia_sap"]
}

TRUNCATE TABLE REFINED.VENDA_DIA_SAP;

CREATE TEMP FUNCTION AJUSTAR_DECIMAL(coluna STRING) AS (
  REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(coluna, r'\.', ''), r'\,', '.'), r'^$', '0.0')
);

CREATE TEMP FUNCTION AJUSTAR_DATA(coluna STRING) AS (
  CASE WHEN coluna <> '' AND NOT(REGEXP_CONTAINS(coluna, r'[A-Za-z]+')) THEN CAST(REGEXP_REPLACE(REGEXP_REPLACE(coluna, r'\.', '-'), r'(\d{2})-(\d{2})-(\d{4})', r'\3-\2-\1') AS TIMESTAMP)
  ELSE NULL
  END
);

INSERT INTO 
    `REFINED.VENDA_DIA_SAP` (
SELECT
  DAT_VENDA,
  COD_FILIAL,
  TIP_VENDA AS TIP_VENDA,
  SAFE_CAST(CASE WHEN REGEXP_CONTAINS(LTRIM(COD_ITPROD_SAP, '0'), r'[A-Za-z]+') THEN NULL ELSE LTRIM(COD_ITPROD_SAP, '0') END AS INT64) AS COD_MATERIAL,
  QTD_VENDA,
  VAL_VENDA,
  VAL_DESCONTO,
  VAL_FRETE,
  VAL_ACRESCIMO,
  VAL_DESPESAS,
  VAL_ICMS,
  VAL_PIS,
  VAL_COFINS,
  VAL_IPI,
  VAL_ISS,
  VAL_TOTAL_IMPOSTO,
  VAL_CMM,
  VAL_COMISSAO,
  CURRENT_TIMESTAMP() AS DATA_ATUALIZACAO,
  "CEV" AS BANDEIRA
FROM `TRUSTED.vendas_venda_dia_sap_cev`

UNION ALL

SELECT
  COALESCE(AJUSTAR_DATA(ZM.Data_Inicio), AJUSTAR_DATA(ZF.Data)) AS DAT_VENDA,
  SAFE_CAST(CASE WHEN LTRIM(COALESCE(ZM.Centro, ZF.Loja)) = '' OR REGEXP_CONTAINS(LTRIM(LTRIM(COALESCE(ZM.Centro, ZF.Loja)), '0'), r'[A-Za-z]+') THEN NULL ELSE LTRIM(COALESCE(ZM.Centro, ZF.Loja)) END AS INT64) AS COD_FILIAL,
  CASE
    WHEN COALESCE(ZM.Centro, ZF.Loja) = ZM.Centro THEN 'V'
    WHEN COALESCE(ZM.Centro, ZF.Loja) = ZF.Loja THEN 'D'
    END AS TIP_VENDA,
  SAFE_CAST(CASE WHEN LTRIM(ZM.N_Material) = '*' OR REGEXP_CONTAINS(LTRIM(ZM.N_Material), r'[A-Za-z]+') THEN NULL ELSE LTRIM(ZM.N_Material) END AS INT64) AS COD_MATERIAL,
  SAFE_CAST(REGEXP_REPLACE(REGEXP_REPLACE(REGEXP_REPLACE(ZM.Qtde_Itens_Material, r'\.', ''), r'\,.*', ''), r'^$', '0') AS INT64) AS QTD_VENDA,
  SAFE_CAST(AJUSTAR_DECIMAL(ZM.Total_Vendido) AS NUMERIC) AS VAL_VENDA,
  SAFE_CAST(AJUSTAR_DECIMAL(ZM.Somatoria_Desconto) AS NUMERIC) AS VAL_DESCONTO,
  SAFE_CAST(AJUSTAR_DECIMAL(ZM.Somatorio_Frete) AS NUMERIC) AS VAL_FRETE,
  SAFE_CAST(AJUSTAR_DECIMAL(ZM.Somatorio_Acresscimo) AS NUMERIC) AS VAL_ACRESCIMO,
  SAFE_CAST(AJUSTAR_DECIMAL(ZM.Somatorio_Despesas) AS NUMERIC) AS VAL_DESPESAS,
  SAFE_CAST(AJUSTAR_DECIMAL(ZM.Somatorio_ICMS) AS NUMERIC) AS VAL_ICMS,
  SAFE_CAST(AJUSTAR_DECIMAL(ZM.Somatorio_PIS) AS NUMERIC) AS VAL_PIS,
  SAFE_CAST(AJUSTAR_DECIMAL(ZM.Somatorio_COFINS) AS NUMERIC) AS VAL_COFINS,
  SAFE_CAST(AJUSTAR_DECIMAL(ZM.Somatorio_IPI) AS NUMERIC) AS VAL_IPI,
  SAFE_CAST(AJUSTAR_DECIMAL(ZM.Somatorio_ISS) AS NUMERIC) AS VAL_ISS,
  SAFE_CAST(AJUSTAR_DECIMAL(ZM.Total_Impostos) AS NUMERIC) AS VAL_TOTAL_IMPOSTO,
  SAFE_CAST(AJUSTAR_DECIMAL(ZM.Somatorio_CMM) AS NUMERIC) AS VAL_CMM,
  SAFE_CAST(AJUSTAR_DECIMAL(LTRIM(ZM.Somatorio_Comissao)) AS NUMERIC) AS VAL_COMISSAO,
  CURRENT_TIMESTAMP() AS DATA_ATUALIZACAO,
  "LB" AS BANDEIRA
FROM `TRUSTED.SAP_ZMMR028_CEV` ZM
LEFT JOIN `TRUSTED.SAP_ZFIR023_CEV` ZF
ON ZM.Centro = ZF.Loja
    )