config {
    dependencies: ["oms_order_items_lb"],
    tags: ["postgresql", "oms", "order_items"]
}

MERGE
`TRUSTED.oms_order_items_lb` T
USING
(
WITH
TABELA AS (
SELECT
DISTINCT id,
	CAST(order_id AS INT64) AS order_id,
	CAST(item_sequence AS INT64) AS item_sequence,
	sku_lb,
	sku_seller,
	ean,
	name,
	CAST(quantity AS INT64) AS quantity,
	CAST(price AS NUMERIC) AS price,
	CAST(total_price AS NUMERIC) AS total_price,
	CAST(shipping_cost AS NUMERIC) AS shipping_cost,
	CAST(discount AS NUMERIC) AS discount,
	discount_name,
	image_url,
	CAST(cancel_quantity AS INT64) AS cancel_quantity,
	CAST(cancel_date AS TIMESTAMP) AS cancel_date,
	CAST(cancel_order AS INT64) AS cancel_order,
	cancel_detail,
	CAST(unity_price AS NUMERIC) AS unity_price,
	sap_code,
	imei
FROM
`RAW.oms_order_items_lb` A
WHERE
PARTITIONTIME=(
SELECT
  MAX(PARTITIONTIME)
FROM
  `RAW.oms_order_items_lb`))
SELECT
*
FROM
TABELA) S
ON
T.id = S.id
WHEN MATCHED THEN UPDATE SET 
T.id = S.id,
T.order_id = S.order_id,
T.item_sequence = S.item_sequence,
T.sku_lb = S.sku_lb,
T.sku_seller = S.sku_seller,
T.ean = S.ean,
T.name = S.name,
T.quantity = S.quantity,
T.price = S.price,
T.total_price = S.total_price,
T.shipping_cost = S.shipping_cost,
T.discount = S.discount,
T.discount_name = S.discount_name,
T.image_url = S.image_url,
T.cancel_quantity = S.cancel_quantity,
T.cancel_date = S.cancel_date,
T.cancel_order = S.cancel_order,
T.cancel_detail = S.cancel_detail,
T.unity_price = S.unity_price,
T.sap_code = S.sap_code,
T.imei = S.imei
WHEN NOT MATCHED
THEN
INSERT
(   id,
	order_id,
	item_sequence,
	sku_lb,
	sku_seller,
	ean,
	name,
	quantity,
	price,
	total_price,
	shipping_cost,
	discount,
	discount_name,
	image_url,
	cancel_quantity,
	cancel_date,
	cancel_order,
	cancel_detail,
	unity_price,
	sap_code,
	imei  )
VALUES
(
    S.id,
	S.order_id,
	S.item_sequence,
	S.sku_lb,
	S.sku_seller,
	S.ean,
	S.name,
	S.quantity,
	S.price,
	S.total_price,
	S.shipping_cost,
	S.discount,
	S.discount_name,
	S.image_url,
	S.cancel_quantity,
	S.cancel_date,
	S.cancel_order,
	S.cancel_detail,
	S.unity_price,
	S.sap_code,
	S.imei  );