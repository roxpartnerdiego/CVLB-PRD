config {
    dependencies: ["SAP_ZCVMM_CUSTO_ESTOQUE"],
    tags: ["sap"]
}

MERGE
  `TRUSTED.SAP_ZCVMM_CUSTO_ESTOQUE` T
USING
  (
  WITH
    TABELA AS (
    SELECT
      DISTINCT MATNR,
        LGORT,
        LABST,
        VERPR
    FROM
        `RAW.SAP_ZCVMM_CUSTO_ESTOQUE` A
    WHERE
      PARTITIONTIME=(
      SELECT
        MAX(PARTITIONTIME)
      FROM
        `RAW.SAP_ZCVMM_CUSTO_ESTOQUE`))
  SELECT
    *
  FROM
    TABELA) S
ON
  T.MATNR = S.MATNR
  WHEN MATCHED THEN UPDATE SET 
  T.MATNR = S.MATNR,
  T.LGORT = S.LGORT,
  T.LABST = S.LABST,
  T.VERPR = S.VERPR
  WHEN NOT MATCHED
  THEN
INSERT
  ( MATNR,
    LGORT,
    LABST,
    VERPR )
VALUES
  ( S.MATNR,
    S.LGORT,
    S.LABST,
    S.VERPR );
